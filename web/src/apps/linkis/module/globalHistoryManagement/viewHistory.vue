<template>
  <div class="global-history">
    <Tabs @on-click="onClickTabs">
      <TabPane name="log" :label="$t('message.linkis.log')"></TabPane>
      <TabPane name="detail" :label="$t('message.linkis.detail')" disabled></TabPane>
      <TabPane name="result" :label="$t('message.linkis.result')"></TabPane>
    </Tabs>
    <Button class="backButton" type="primary" @click="back">{{$t('message.linkis.back')}}</Button>
    <Icon
      v-show="isLoading"
      type="ios-loading"
      size="30"
      class="global-history-loading"/>
    <log
      v-if="tabName === 'log'"
      :logs="logs"
      :from-line="fromLine"/>
    <result
      v-if="tabName === 'result'"
      ref="result"
      :script="script"
      :dispatch="dispatch"
      :visualShow="visualShow"
      :script-view-state="scriptViewState"
      :dataWranglerParams="dataWranglerParams"
      getResultUrl="filesystem"
      @on-set-change="changeResultSet"
      @on-analysis="openAnalysisTab"
      :visualParams="visualParams" />
  </div>
</template>
<script>
import result from '@/components/consoleComponent/result.vue';
import log from '@/components/consoleComponent/log.vue';
import api from '@/common/service/api';
import mixin from '@/common/service/mixin';
import util from '@/common/util';
import { isUndefined } from 'lodash';
export default {
  components: {
    log,
    result
  },
  mixins: [mixin],
  props: {},
  data() {
    return {
      hasResultData: false,
      isLoading: true,
      tabName: 'log',
      visualShow: 'table',
      dataWranglerParams: {},
      script: {
        data: '',
        oldData: '',
        result: {},
        steps: [],
        progress: {},
        resultList: null,
        resultSet: 0,
        params: {},
        readOnly: false
      },
      visualParams: {},
      scriptViewState: {
        topPanelHeight: '250px',
        bottomContentHeight: '250',
        topPanelFull: false,
        showPanel: 'log',
        bottomPanelFull: false,
        cacheLogScroll: 0,
      },
      logs: {
        all: '',
        error: '',
        warning: '',
        info: '',
      },
      fromLine: 1,
      isAdminModel: false,
      jobhistoryTask: null,
    };
  },
  created() {
    this.hasResultData = false;
  },
  mounted() {
    let taskID = this.$route.query.taskID
    this.initHistory(taskID)
  },
  methods: {
    // 点击tab时触发请求，log初始就请求了，不做判断
    onClickTabs(name) {
      this.tabName = name;
      if(name === 'result') { // 判断是否为结果集
        if(this.hasResultData) return; // 判断是否已经获取过数据，获取过则直接返回
        if (this.jobhistoryTask && this.jobhistoryTask.resultLocation) { // 判断是否有资源地址，如果没有则不发请求
          this.getResult(this.jobhistoryTask);
        } else {
          this.$Notice.warning({
            title: this.$t('message.linkis.tip'),
            desc: this.$t('message.linkis.serverTip')
          });
        }
      }
    },
    changeResultSet(data, cb) {
      const resultSet = isUndefined(data.currentSet) ? this.script.resultSet : data.currentSet;
      const findResult = this.script.resultList[resultSet];
      const resultPath = findResult && findResult.path;
      const hasResult = Object.prototype.hasOwnProperty.call(this.script.resultList[resultSet], 'result');
      if (!hasResult) {
        const pageSize = 5000;
        const url = '/filesystem/openFile';
        api.fetch(url, {
          path: resultPath,
          pageSize,
        }, 'get')
          .then((ret) => {
            const result = {
              'headRows': ret.metadata,
              'bodyRows': ret.fileContent,
              // 如果totalLine是null，就显示为0
              'total': ret.totalLine ? ret.totalLine : 0,
              // 如果内容为null,就显示暂无数据
              'type': ret.fileContent ? ret.type : 0,
              'path': resultPath,
              'current': 1,
              'size': 20,
            };
            this.script.resultList[resultSet].result = result;
            this.script.resultSet = resultSet;
            this.script = {
              ...this.script
            };
            this.updateResult({
              tabId: this.script.id,
              resultSet,
              showPanel: 'result',
              ...this.script.resultList,
            });
            cb();
          }).catch(() => {
            cb();
          });
      } else {
        this.script.resultSet = resultSet;
        this.script = {
          ...this.script
        };
        this.updateResult({
          tabId: this.script.id,
          resultSet: resultSet,
          showPanel: 'result',
          ...this.script.resultList,
        });
        cb();
      }
    },
    // 将数组格式化成json形式。
    openAnalysisTab(type) {
      this.visualShow = type;
      if (type === 'visual') {
        this.biLoading = true;
        let rows = this.scriptResult.headRows;
        let model = {}
        let dates = ["DATE", "DATETIME", "TIMESTAMP", "TIME", "YEAR"]
        let numbers = [
          "TINYINT",
          "SMALLINT",
          "MEDIUMINT",
          "INT",
          "INTEGER",
          "BIGINT",
          "FLOAT",
          "DOUBLE",
          "DOUBLE PRECISION",
          "REAL",
          "DECIMAL",
          "BIT",
          "SERIAL",
          "BOOL",
          "BOOLEAN",
          "DEC",
          "FIXED",
          "NUMERIC"];
        rows.forEach(item=>{
          let sqlType = item.dataType.toUpperCase();
          let visualType = 'string'
          if (numbers.indexOf(sqlType) > -1) {
            visualType = 'number'
          } else if(dates.indexOf(sqlType) > -1) {
            visualType = 'date'
          }
          model[item.columnName] =  {
            sqlType,
            visualType,
            modelType: visualType ==="number" ? "value": "category"
          }
        })
        this.visualParams = {
          // viewId: id,
          // projectId,
          json: {
            name: `${this.script.fileName.replace(/\./g,'')}${this.script.resultSet}`,
            model,
            source: {
              "engineType": "spark", //引擎类型
              "dataSourceType": "resultset", //数据源类型，结果集、脚本、库表
              "dataSourceContent": {
                "resultLocation": this.scriptResult.path
              },
              "creator": "IDE"
            }
          }
        }
      } else if (type === 'dataWrangler') {
        this.dataWranglerParams = {
          simpleMode: true,
          showBottomBar: false,
          importConfig: {
            "dataSourceConfig": {
              "dataSourceType": "linkis",
              "dataSourceOptions": {"taskID": this.work.taskID || this.work.data.history[0].taskID}
            },
            "config": {
              "myConfig": {
                "resultSetPath": [this.scriptResult.path]
              },
              "importConfig": {
                "mergeTables": true,
                "limitRows": 5000,
                "pivotTable": false,
                "tableHeaderRows": 1,
              }
            }
          }
        }
      }
    },
    // 获取历史详情
    async initHistory(jobId) {
      try {
        let jobhistory = await api.fetch(`/jobhistory/${jobId}/get`, 'get');
        const option = jobhistory.task;
        this.jobhistoryTask = option;
        if (!jobhistory.task.logPath) {
          const errCode = jobhistory.task.errCode ? '\n错误码：' + jobhistory.task.errCode : '';
          const errDesc = jobhistory.task.errDesc ? '\n错误描述：' + jobhistory.task.errDesc : '';
          const info = '未获取到日志！' + errCode + errDesc;
          this.logs = { all: info, error: '', warning: '', info: '' };
          this.fromLine = 1;
          return;
        }
        const params = {
          path: jobhistory.task.logPath,
        };
        // 管理员模式，从GlobalHistory复制过来的代码，待询问需求
        if (this.isAdminModel) {
          params.proxyUser = jobhistory.task.umUser;
        }
        let openLog = await api.fetch('/filesystem/openLog', params, 'get');
        if (openLog) {
          const log = { all: '', error: '', warning: '', info: '' };
          const convertLogs = util.convertLog(openLog.log);
          Object.keys(convertLogs).forEach((key) => {
            if (convertLogs[key]) {
              log[key] += convertLogs[key] + '\n';
            }
          });
          this.logs = log;
          this.fromLine = log['all'].split('\n').length;
        }
        this.isLoading = false;
      } catch (errorMsg) {
        console.error(errorMsg);
        this.isLoading = false;
      }
    },
    // 获取结果集内容
    async getResult(option) {
      this.isLoading = true;
      const url1 = `/filesystem/getDirFileTrees`;
      const rst = await api.fetch(url1, {
        path: option.resultLocation,
      }, 'get');
      if (rst.dirFileTrees) {
        // 后台的结果集顺序是根据结果集名称按字符串排序的，展示时会出现结果集对应不上的问题，所以加上排序
        let scriptResultList = rst.dirFileTrees.children.sort((a, b) => parseInt(a.name, 10) - parseInt(b.name,
          10));
        if (scriptResultList.length) {
          const currentResultPath = rst.dirFileTrees.children[0].path;
          const url2 = `/filesystem/openFile`;
          api.fetch(url2, {
            path: currentResultPath,
            page: 1,
            pageSize: 5000,
          }, 'get').then((ret) => {
            let tmpResult = {
              'headRows': ret.metadata,
              'bodyRows': ret.fileContent,
              'total': ret.totalLine,
              'type': ret.type,
              'path': currentResultPath,
            };
            this.script.resultSet = 0
            this.script.resultList = scriptResultList;
            this.$set(this.script.resultList[0], 'result', {});
            Object.assign(this.script.resultList[0].result, tmpResult)
            this.scriptViewState.showPanel = 'result';
          });
        }
        this.hasResultData = true;
        this.isLoading = false;
      } else {// 没有返回则设置一个初始化数据
        let tmpResult = {
          'headRows': [],
          'bodyRows': [],
          'total': 0,
          'type': '2',
          'path': '',
        };
        this.script.resultSet = 0
        this.script.resultList = [{}];
        this.$set(this.script.resultList[0], 'result', {});
        Object.assign(this.script.resultList[0].result, tmpResult)
        this.scriptViewState.showPanel = 'result';
        this.isLoading = false;
      }
    },
    // 返回上一页
    back() {
      if (this.isLoading) {
        return this.$Message.warning(this.$t('message.linkis.logLoading'));
      }
      this.$router.go(-1)
    },
  },
};
</script>
<style lang="scss" scoped>
  /deep/.we-result-view .table-box {
    height: calc(100% - 100px);
    /deep/.table-div {
      min-height: 250px;
      height: 100%!important;
    }
  }
  .backButton {
    position: absolute;
    top: 0;
    right: 20px;
  }
</style>

